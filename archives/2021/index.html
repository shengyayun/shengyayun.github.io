<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="ie=edge"><title>shengyayun's Notebook</title><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css"><script src="/js/third-party/jquery.min.js">           </script><script src="/js/third-party/velocity.min.js">           </script><script src="/js/third-party/velocity.ui.min.js">           </script><link rel="icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="shengyayun's Notebook" type="application/atom+xml">
</head><body><nav id="nav-bar"><nav class="clear-fix" id="nav-container"><div class="pull-left" id="page-home"><a href="/">shengyayun's Notebook</a></div><i class="fa fa-bars pull-right" id="toggle-nav" aria-hidden="true"></i><ul class="pull-right" id="navs"><li><a class="nav" href="/">Home</a></li><li><a class="nav" href="/tags">Tags</a></li><li><a class="nav" href="/about">About</a></li></ul></nav></nav><header id="header-info"><div id="header-container"><div id="site-info"><div id="terminal-pl"><div id="top-bar"><ul id="control"><li class="btn"></li><li class="btn"></li><li class="btn"></li></ul><div id="file-path"><i class="fa fa-folder folder-ic" aria-hidden="true"></i> shengyayun 10 X 10</div></div><div id="code-pl"></div></div></div></div></header><div id="content-outer"><div id="content-inner"><div class="recent-post-item"><a class="article-title" href="/2021/09/05/prometheus/">Prometheus</a><time class="article-date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-05</time><div class="article-inner"><blockquote>
<p>Prometheusis an open-source systems monitoring and alerting toolkit originally built at SoundCloud.<br>普罗米修斯是最初由SoundCloud建立的一套开源的系统监控及预警的工具。</p>
</blockquote>
<p>[TOC]</p>
<h3 id="一-软件简介"><a href="#一-软件简介" class="headerlink" title="一. 软件简介"></a>一. 软件简介</h3><p>Prometheus 与 Influxdb都是时序数据库，比起关系型数据库，它们在时间序列数据的处理上具有极大的优势，例如长期高频率记录温度传感器的数值，该数据跟时间关联较大，且数据量极大。</p>
<h3 id="二-安装-Prometheus"><a href="#二-安装-Prometheus" class="headerlink" title="二. 安装 Prometheus"></a>二. 安装 Prometheus</h3><h4 id="1-下载"><a href="#1-下载" class="headerlink" title="1. 下载"></a>1. 下载</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># /opt 目录类似于Windows的C://Program Files/目录</span><br><span class="line">cd /opt/</span><br><span class="line"># 下载prometheus的压缩文件</span><br><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.29.1/prometheus-2.29.1.linux-amd64.tar.gz</span><br><span class="line"># 解压</span><br><span class="line">tar xzvf prometheus-2.29.1.linux-amd64.tar.gz</span><br><span class="line"># 创建软链接，便于后续进行版本升级</span><br><span class="line">ln -snf /opt/prometheus-2.29.1.linux-amd64.tar.gz /opt/prometheus</span><br></pre></td></tr></table></figure>

<h4 id="2-Systemd"><a href="#2-Systemd" class="headerlink" title="2. Systemd"></a>2. Systemd</h4><p>创建Service文件<code>vi /usr/lib/systemd/system/prometheus.service</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Prometheus</span><br><span class="line">After=network.target # 依赖于网络服务</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple # 启动类型：ExecStart 创建的进程作为主进程</span><br><span class="line">User=nobody # 执行用户使用 nobody</span><br><span class="line">ExecStart=/opt/prometheus/prometheus --config.file=/opt/prometheus/prometheus.yml --storage.tsdb.path=/mnt/var/prometheus --web.console.libraries=/opt/prometheus/console_libraries --web.console.templates=/opt/prometheus/consoles --web.enable-lifecycle # 启动 prometheus 进程</span><br><span class="line">Restart=on-failure # 失败自动重启</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target # 可以通过 systemctl enable 启用，将会将该服务包含到 multi-user.target 中，这样在启动 multi-user.target 时，将会自动启动 multi-user.target</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用Systemd的Service的好处在于，可以开机自启动，并且失败可以自动重启，简化了运维管理。</p>
<p>重新加载Service文件：<code>systemctl daemon-reload</code><br>开机自启动：<code>systemctl enable prometheus</code><br>启动服务：<code>systemctl start prometheus</code><br>查看服务状态：<code>systemctl status prometheus</code><br>查看服务输出：<code>journalctl -xe -u prometheus</code></p>
</blockquote>
<h4 id="3-自带的图形化界面"><a href="#3-自带的图形化界面" class="headerlink" title="3. 自带的图形化界面"></a>3. 自带的图形化界面</h4><p>访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:9090/graph">http://127.0.0.1:9090/graph</a></p>
<h3 id="三-安装-Exporter"><a href="#三-安装-Exporter" class="headerlink" title="三. 安装 Exporter"></a>三. 安装 Exporter</h3><blockquote>
<p>Prometheus 的官方与第三方提供了多种 Exporter，它们会采集各种监控数据，供Prometheus定期拉取（Pull）。</p>
</blockquote>
<h4 id="1-Node-Exporter（硬件与操作系统）"><a href="#1-Node-Exporter（硬件与操作系统）" class="headerlink" title="1. Node Exporter（硬件与操作系统）"></a>1. Node Exporter（硬件与操作系统）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v1.2.2/node_exporter-1.2.2.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<p><code>vi /usr/lib/systemd/system/node_exporter.service</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=NodeExporter</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=nobody</span><br><span class="line">ExecStart=/opt/node_exporter/node_exporter</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p><code>systemctl daemon-reload &amp; systemctl enable node_exporter &amp; systemctl start node_exporter</code></p>
<h4 id="2-Mysqld-Exporter（MySQL服务）"><a href="#2-Mysqld-Exporter（MySQL服务）" class="headerlink" title="2. Mysqld Exporter（MySQL服务）"></a>2. Mysqld Exporter（MySQL服务）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.13.0/mysqld_exporter-0.13.0.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<p><code>vi /usr/lib/systemd/system/mysqld_exporter.service</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=MysqldExporter</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=nobody</span><br><span class="line">Environment=DATA_SOURCE_NAME=user:password@(hostname:3306)/ # TODO Change</span><br><span class="line">ExecStart=/opt/mysqld_exporter/mysqld_exporter</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p><code>systemctl daemon-reload &amp; systemctl enable mysqld_exporter &amp; systemctl start mysqld_exporter</code></p>
<h4 id="3-Kafka-Exporter"><a href="#3-Kafka-Exporter" class="headerlink" title="3. Kafka Exporter"></a>3. Kafka Exporter</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/danielqsj/kafka_exporter/releases/download/v1.3.1/kafka_exporter-1.3.1.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<p><code>vi /usr/lib/systemd/system/kafka_exporter.service</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=KafkaExporter</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=nobody</span><br><span class="line">ExecStart=/opt/mysqld_exporter/kafka_exporter</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p><code>systemctl daemon-reload &amp; systemctl enable kafka_exporter &amp; systemctl start kafka_exporter</code></p>
<h3 id="四-Pull"><a href="#四-Pull" class="headerlink" title="四. Pull"></a>四. Pull</h3><blockquote>
<p>Prometheus 根据配置文件中的<code>scrape_configs</code>，自动定期拉从Exporter拉取数据。</p>
</blockquote>
<h4 id="1-修改配置文件"><a href="#1-修改配置文件" class="headerlink" title="1. 修改配置文件"></a>1. 修改配置文件</h4><p><code>vi /opt/prometheus/prometheus.yml</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># 全局配置</span><br><span class="line">global:</span><br><span class="line">  scrape_interval: 15s # 每隔15s从Exporter拉取一次数据（根据scrape_configs）</span><br><span class="line">  evaluation_interval: 15s # 每隔15s计算一次规则（根据rule_files）</span><br><span class="line"></span><br><span class="line"># Alertmanager相关配置</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">          # - alertmanager:9093</span><br><span class="line"></span><br><span class="line"># 规则文件列表</span><br><span class="line">rule_files:</span><br><span class="line"></span><br><span class="line"># 抓取配置列表</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;prometheus&quot; # 自带的Job，拉取Prometheus自身的数据</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9090&quot;]</span><br><span class="line"></span><br><span class="line">## 以下为新增项</span><br><span class="line"></span><br><span class="line">  - job_name: &quot;nodes&quot; # 拉取 Node Exporter 的数据</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9100&quot;] # Node Exporter 默认监听 9100 端口</span><br><span class="line"></span><br><span class="line">  - job_name: &quot;mysqld&quot; # 拉取 Mysqld Exporter 的数据</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9104&quot;] # Node Exporter 默认监听 9104 端口</span><br><span class="line"></span><br><span class="line">  - job_name: &quot;kafka&quot; # 拉取 Kafka Exporter 的数据</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9308&quot;] # Node Exporter 默认监听 9308 端口</span><br><span class="line"></span><br><span class="line">  - job_name: &quot;pushgateway&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9091&quot;] # PushGateway 默认监听 9091 端口</span><br></pre></td></tr></table></figure>
<h4 id="2-要求Prometheus重新加载配置文件"><a href="#2-要求Prometheus重新加载配置文件" class="headerlink" title="2. 要求Prometheus重新加载配置文件"></a>2. 要求Prometheus重新加载配置文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 如果未添加 -web.enable-lifecycle，这个接口会返回：Lifecycle API is not enabled</span><br><span class="line">curl -X POST http://localhost:9090/-/reload</span><br></pre></td></tr></table></figure>


<h3 id="五-更好的可视化工具：Grafana"><a href="#五-更好的可视化工具：Grafana" class="headerlink" title="五. 更好的可视化工具：Grafana"></a>五. 更好的可视化工具：Grafana</h3><h4 id="1-安装并启动"><a href="#1-安装并启动" class="headerlink" title="1. 安装并启动"></a>1. 安装并启动</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.grafana.com/oss/release/grafana-8.1.1-1.x86_64.rpm</span><br><span class="line">yum install grafana-8.1.1-1.x86_64.rpm</span><br><span class="line"></span><br><span class="line">systemctl start grafana-server</span><br></pre></td></tr></table></figure>

<h4 id="2-初始管理员密码"><a href="#2-初始管理员密码" class="headerlink" title="2. 初始管理员密码"></a>2. 初始管理员密码</h4><p>访问 <a target="_blank" rel="noopener" href="http://localhost:3000/">http://localhost:3000</a>, 默认账户为 admin:admin， admin首次登陆需要重设密码。</p>
<h4 id="3-数据源与模板"><a href="#3-数据源与模板" class="headerlink" title="3. 数据源与模板"></a>3. 数据源与模板</h4><p>添加Prometheus为数据源，然后去Grafana的<a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards?dataSource=prometheus" title="Dashboards">Dashboards</a>找一些合适的模板。</p>
<p><a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/8919" title="1 Node Exporter for Prometheus Dashboard CN v20201010">1 Node Exporter for Prometheus Dashboard CN v20201010</a>：</p>
</div><div class="article-footer"><a class="article-more" href="/2021/09/05/prometheus/#more">more>></a><div class="article-tags"><i class="fa fa-tag" aria-hidden="true"></i><a class="article-tag" href="/tags/#centos">centos</a><a class="article-tag" href="/tags/#prometheus">prometheus</a></div></div></div><div class="recent-post-item"><a class="article-title" href="/2021/03/27/cheatsheet-for-ssh/">SSH的常用指令</a><time class="article-date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-03-27</time><div class="article-inner"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成密钥对</span></span><br><span class="line">ssh-keygen -t rsa -P <span class="string">&#x27;&#x27;</span> -m PEM</span><br><span class="line"></span><br><span class="line"><span class="comment"># 权限设置</span></span><br><span class="line">chmod 700 .ssh </span><br><span class="line">chmod 600 .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转换OpenSSH格式</span></span><br><span class="line">puttygen id_rsa -o id_rsa.ppk</span><br><span class="line">puttygen id_rsa.ppk -O private-openssh -o id_rsa2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 排查异常登录的IP使用的公钥</span></span><br><span class="line">cat /var/<span class="built_in">log</span>/secure | grep 115.192.217.112</span><br><span class="line"><span class="comment"># Accepted publickey for root from 115.192.217.112 port 57305 ssh2: RSA SHA256:4egcXPHAIXpN7XxEiBQVV5dWEtQvi4JzbicrBJRZp1I</span></span><br><span class="line">ssh-keygen -lf ~/.ssh/authorized_keys | grep 4egcXPHAIXpN7XxEiBQVV5dWEtQvi4JzbicrBJRZp1I</span><br></pre></td></tr></table></figure></div><div class="article-footer"><a class="article-more" href="/2021/03/27/cheatsheet-for-ssh/#more">more>></a><div class="article-tags"><i class="fa fa-tag" aria-hidden="true"></i></div></div></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span></div></nav></div></div><footer><div id="footer-inner"><div class="social-icons"><a class="social-icon" href="https://github.com/shengyayun" target="_blank"><i class="fa fa-github"></i></a></div><p class="design-info">Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme <a href="https://github.com/lazysheep666/terminal_theme" target="_blank">Teminal</a> (<a href="https://github.com/Tonny-Gu/terminal_theme" target="_blank">NekoDaemon Remix</a>)</p><p class="design-info"><a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a> 
Licensed | Copyright © 2022 shengyayun</p></div></footer><script src="/js/nav.js"></script><script src="/js/scroll.js"></script><script src="/js/index.js"></script></body></html>